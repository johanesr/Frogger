<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Week 1</title>
  <script type="text/javascript" src="babylon.custom.js">
  </script>
  <script type="text/javascript" src="material.js">
  </script>
  <script type="text/javascript" src="animations.js">
  </script>
  <script type="text/javascript" src="GroundTexture.js">
+  </script>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
  <canvas id="renderCanvas"></canvas>
  <script>
  var clones = [];
  var masterclones = [];
  var jump = false;
  var canvas = document.getElementById("renderCanvas");
  var engine = new BABYLON.Engine(canvas, true);
  var start = false;
  var count = -22;
  var bb8;

  var createScene = function()
  {
    var engine, scene, camera;

    scene = new BABYLON.Scene(engine);
    gravity = new BABYLON.Vector3(0,-9.81,0);
    physicsEngine = new BABYLON.CannonJSPlugin();
    scene.enablePhysics(gravity, physicsEngine);

    var camera = new BABYLON.FollowCamera("Camera", new BABYLON.Vector3(0, 4.5 ,10), scene);
    camera.radius = 35;
    camera.heightOffSet = 50;
    //camera.rotationOffset = 90;
    camera.cameraAcceleration = 0.5;
    camera.attachControl(canvas, true);

    // The box creation
    // var skybox = BABYLON.Mesh.CreateBox("skyBox", 2000.0, scene);
    //
    // // The sky creation
    // var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
    // skyboxMaterial.backFaceCulling = false;
    // skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
    // skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
    // skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("assets/skybox/cubemap", scene);
    // skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
    //
    //
    // skybox.material = skyboxMaterial;

    groundTexture = GroundTexture(scene);
    ground = new BABYLON.Mesh.CreateGround("ground", 2000, 2000, 1,scene);
    ground.material = groundTexture;

    ground.physicsImpostor = new BABYLON.PhysicsImpostor(ground,
    BABYLON.PhysicsImpostor.BoxImpostor, {mass:0, restitution: 0.2, friction: 0.2},scene);

    new BABYLON.SceneLoader.ImportMesh("", "bb-unit-babylon/", "bb-unit.babylon", scene, function (newMeshes) {
      bb8 = newMeshes[0];
      bb8.name = "bb8";
      bb8.scaling = new BABYLON.Vector3(0.02, 0.02, 0.02);
      //bb8.position.y=1.2;
      bb8.position = new BABYLON.Vector3(0, 1.15, 10 );
      //bb8.addRotation(0,Math.PI/4,0);
      //console.log(bb8.position);
      camera.lockedTarget = bb8;
      bb8forward = function ()
      {
        forward(bb8,scene,bb8.position,function(){ jump = false});
        console.log(bb8.position);
      }
      bb8back = function ()
      {
        back(bb8,scene,bb8.position,function(){ jump = false});
      }
      // bb8.physicsImpostor = new BABYLON.PhysicsImpostor(bb8,
      // BABYLON.PhysicsImpostor.BoxImpostor,{mass:1, restitution: 0.5, friction: 0.2},scene);
    });

    var enemy=new BABYLON.SceneLoader.ImportMesh("", "stormtrooper-babylon/", "stormtrooper.babylon", scene, function (newMeshes) {
      monster = newMeshes[0];
      monster.scaling = new BABYLON.Vector3(1.5, 1.5, 1.5);
      monster.addRotation(0,Math.PI/2,0);
      monster.position.x;
      console.log(monster.position);
      cleaning = function()
      {
        for(var i = 0; i<clones.length;i++)
        {
          if(clones[i].position.x>101 || clones.position.x<-101)
          {
            clones[i].dispose();
            clones.splice(i, 1);
          }
        }
      }
      disposing = function ()
      {
        if(bb8.position.z-masterclones[masterclones.length-1].position.z>40)
        {
          for(var i =0; i<clones.length;i++)
          {
            if(masterclones[masterclones.length-1].position.z == clones[i].position.z)
            {
              clones[i].dispose();
              clones.splice(i,1);
            }
          }
          masterclones[masterclones.length-1].dispose();
          masterclones.pop();
        }
        //console.log(masterclones.length);
      }
      disposefront = function ()
      {
        if(bb8.position.z-masterclones[0].position.z<-20)
        {
          for(var i =0; i<clones.length;i++)
          {
            if(masterclones[0].position.z == clones[i].position.z)
            {
              clones[i].dispose();
              clones.splice(i,1);
            }
          }
          masterclones[0].dispose();
          masterclones.shift();
        }
      }
      mastercloning = function(pos)
      {
          if(pos>20)
          {
            var master = monster.clone();
            master.scaling = new BABYLON.Vector3(0.01,0.01,0.01);
            if(masterclones.length!=0)
            {
              master.position.z = masterclones[masterclones.length-1].position.z-4;
            }
            else {
              master.position.z = count;
              count = count -4;
            }
            if(pos<60)
            {
              master.position.x = 100;
            }
            else
            {
              master.position.x = -100;
              master.addRotation(0,Math.PI,0);
            }
            masterclones.push(master);
          }

      }
      for(var i=0;i<6;i++)
      {
        mastercloning(Math.floor((Math.random() * 80))+21);
      }
      mastercloningback = function(pos,z)
      {
        if(masterclones[0].position.z-bb8.position.z<40 && bb8.position.z<-42)
        {
          if(pos>20)
          {
            var master = monster.clone();
            master.scaling = new BABYLON.Vector3(0.01,0.01,0.01);
            master.position.z = masterclones[0].position.z+4;
            //count = count-4;
            if(pos<60)
            {
              master.position.x = 100;
            }
            else
            {
              master.position.x = -100;
              master.addRotation(0,Math.PI,0);
            }
            masterclones.unshift(master);
          }
        }
      }
      cloning = function ()
      {
        var num = Math.floor((Math.random() * masterclones.length));
        if(Math.floor((Math.random() * 100))<50)
        {
          var clone = masterclones[num].clone();
          clone.scaling  = new BABYLON.Vector3(1.5,1.5,1.5);
          clones.push(clone);
        }
      };
      move = function ()
      {
        for(var j = 0; j<clones.length;j++)
        {
          var found =0;
          for(var i= 0; i<masterclones.length;i++)
          {
            if(masterclones[i].position.z == clones[j].position.z)
            {
              if(masterclones[i].position.x<0)
              {
                clones[j].position.x = clones[j].position.x + 0.25;
              }
              else {
                clones[j].position.x = clones[j].position.x - 0.25;
              }
              found =1;
            }
            else if(i == masterclones.length-1 && found ==0)
            {
              clones[j].dispose();
              clones.splice(j,1);
            }
          }
        }
      }
      // monster.position = new BABYLON.Vector3(0, 0, 0);
    });
    //bb8foward();

    var light = new BABYLON.HemisphericLight("hLight",
    new BABYLON.Vector3(0, 10, 0), scene);


    //

    var box2 = new BABYLON.Mesh.CreateBox("box2", 4000, scene);
    box2.scaling.z = 0.00025;
    box2.position = new BABYLON.Vector3(0, 500, -975);
    // box2.physicsImpostor = new BABYLON.PhysicsImpostor(box2,
    // BABYLON.PhysicsImpostor.BoxImpostor,{mass:1, restitution: 0.5, friction: 0.2},scene);
    box2.isVisible=true;

    var mat2 = createMat(scene);

    box2.material = mat2;
    return scene;
  }


  document.addEventListener("DOMContentLoaded", function()
  {


  });

    window.onkeydown = function(event)
    {
      //bb8forward();
      if(event.keyCode==87 && jump==false)
      {
        jump = true;
        bb8forward();
        if(bb8.position.z-40<masterclones[masterclones.length-1].position.z)
        {
          console.log("HAHA");
          mastercloning(Math.floor((Math.random() * 100)));
        }
        count = count-4;
        if(masterclones.length>20)
        {
          disposefront();
        }
        console.log(clones.length);
      }
      if(event.keyCode==83 && jump==false && count<-46)
      {
        jump = true;
        bb8back();
        count = count+4;
        // console.log(mas);
        mastercloningback(Math.floor((Math.random() * 100)));
        if(masterclones.length>20)
        {
          disposing();
        }
      }
    }
    var scene = createScene();
      setInterval(function(){ cloning(); }, 500);

    engine.runRenderLoop(function()
    {
      if(scene)
      {
        if(clones.length>1)
        {
          move();
        }

        // if(bb8!=null)
        // {
        //   //console.log(count);
        //   if(count-bb8.position.z > -23)
        //   {
        //     mastercloning(Math.floor((Math.random() * 100)));
        //   }
        // }
      }
      scene.render();
    });

</script>
</body>
</html>
